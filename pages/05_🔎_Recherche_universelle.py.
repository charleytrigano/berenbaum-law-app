# pages/05_ğŸ”_Recherche_universelle.py
import streamlit as st
import pandas as pd

from utils.sidebar import render_sidebar
from backend.dropbox_utils import load_database
from utils.status_utils import normalize_bool

# =====================================================
# CONFIG
# =====================================================
st.set_page_config(
    page_title="ğŸ” Recherche universelle",
    page_icon="ğŸ”",
    layout="wide"
)
render_sidebar()
st.title("ğŸ” Recherche universelle des dossiers")

# =====================================================
# LOAD DATABASE
# =====================================================
db = load_database()
clients = db.get("clients", [])

if not clients:
    st.warning("Aucun dossier disponible.")
    st.stop()

df = pd.DataFrame(clients).copy()

# =====================================================
# NORMALISATION
# =====================================================
df["Dossier N"] = df["Dossier N"].astype(str)
df["Nom"] = df.get("Nom", "").astype(str)

def to_float(v):
    try:
        return float(v or 0)
    except:
        return 0.0

df["Total facturÃ©"] = (
    df.get("Montant honoraires (US $)", 0).apply(to_float)
    + df.get("Autres frais (US $)", 0).apply(to_float)
)

df["Total encaissÃ©"] = 0.0
for i in range(1, 5):
    col = f"Acompte {i}"
    if col in df.columns:
        df["Total encaissÃ©"] += df[col].apply(to_float)

df["Solde"] = df["Total facturÃ©"] - df["Total encaissÃ©"]

# =====================================================
# HIERARCHIE PARENT / FILS
# =====================================================
def parent_id(x):
    return x.split("-", 1)[0] if "-" in x else x

def index_id(x):
    if "-" not in x:
        return 0
    try:
        return int(x.split("-", 1)[1])
    except:
        return 0

df["Dossier Parent"] = df["Dossier N"].apply(parent_id)
df["Dossier Index"] = df["Dossier N"].apply(index_id)

# =====================================================
# FILTRES
# =====================================================
st.subheader("ğŸ¯ Filtres")

f1, f2, f3, f4 = st.columns(4)

search_text = f1.text_input("ğŸ” Recherche (Nom ou Dossier N)").strip().lower()

status_options = {
    "EnvoyÃ©": "Dossier envoye",
    "AcceptÃ©": "Dossier accepte",
    "RefusÃ©": "Dossier refuse",
    "AnnulÃ©": "Dossier Annule",
    "RFE": "RFE",
}
status_selected = f2.multiselect("Statuts", list(status_options.keys()))

solde_filter = f3.selectbox(
    "Solde",
    ["Tous", "SoldÃ©s (0)", "Non soldÃ©s (>0)", "Solde nÃ©gatif (<0)"]
)

escrow_filter = f4.selectbox(
    "Escrow",
    ["Tous", "Actif", "Ã€ rÃ©clamer", "RÃ©clamÃ©"]
)

# =====================================================
# APPLICATION DES FILTRES
# =====================================================
df_view = df.copy()

# Recherche texte
if search_text:
    df_view = df_view[
        df_view["Nom"].str.lower().str.contains(search_text)
        | df_view["Dossier N"].str.lower().str.contains(search_text)
    ]

# Statuts
if status_selected:
    mask = False
    for label in status_selected:
        col = status_options[label]
        if col in df_view.columns:
            mask = mask | df_view[col].apply(normalize_bool)
    df_view = df_view[mask]

# Solde
if solde_filter == "SoldÃ©s (0)":
    df_view = df_view[df_view["Solde"].round(2) == 0]
elif solde_filter == "Non soldÃ©s (>0)":
    df_view = df_view[df_view["Solde"] > 0]
elif solde_filter == "Solde nÃ©gatif (<0)":
    df_view = df_view[df_view["Solde"] < 0]

# Escrow
if escrow_filter != "Tous":
    if escrow_filter == "Actif":
        df_view = df_view[df_view.get("Escrow", False).apply(normalize_bool)]
    elif escrow_filter == "Ã€ rÃ©clamer":
        df_view = df_view[df_view.get("Escrow_a_reclamer", False).apply(normalize_bool)]
    elif escrow_filter == "RÃ©clamÃ©":
        df_view = df_view[df_view.get("Escrow_reclame", False).apply(normalize_bool)]

# =====================================================
# AFFICHAGE
# =====================================================
st.markdown("---")
st.subheader(f"ğŸ“„ RÃ©sultats ({len(df_view)} dossiers)")

display_cols = [
    "Dossier N", "Nom", "Visa",
    "Montant honoraires (US $)", "Autres frais (US $)",
    "Total encaissÃ©", "Solde",
    "Escrow", "Escrow_a_reclamer", "Escrow_reclame",
    "Dossier envoye", "Dossier accepte", "Dossier refuse", "Dossier Annule"
]

cols = [c for c in display_cols if c in df_view.columns]

st.dataframe(
    df_view.sort_values(["Dossier Parent", "Dossier Index", "Dossier N"])[cols],
    use_container_width=True
)